name: GitHub ì´ìŠˆ â†’ Jira ì´ìŠˆ ìƒì„± ë° ë¸Œëœì¹˜ ìë™í™”
on:
  issues:
    types:
      - opened

jobs:
  create-jira-and-branch:
    name: Jira Task ìƒì„± ë° ë¸Œëœì¹˜ ìƒì„±
    runs-on: ubuntu-latest
    steps:
      - name: main ë¸Œëœì¹˜ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: main

      # ref : https://github.com/peter-evans/jira2md
      - name: Github ì´ìŠˆ ë§ˆí¬ë‹¤ìš´ì„ Jira ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ìœ¼ë¡œ ë³€í™˜
        uses: peter-evans/jira2md@v1
        id: md2jira
        with:
          input-text: |
            ### Github Issue Link
            - ${{ github.event.issue.html_url }}

            ${{ github.event.issue.body }}
          mode: md2jira

      - name: ì´ìŠˆ íƒ€ì… ì¶”ì¶œ
        id: extract_issue_type
        run: |
          title="${{ github.event.issue.title }}"
          issue_type=$(echo "$title" | sed -n 's/^\[\([^]]*\)\].*/\1/p' | tr '[:upper:]' '[:lower:]')
          echo "issue_type=$issue_type" >> $GITHUB_OUTPUT

      - name: ì œëª©ì—ì„œ [íƒ€ì…]ì„ [BE/íƒ€ì…]ìœ¼ë¡œ ë³€í™˜
        id: convert_title
        run: |
          title="${{ github.event.issue.title }}"
          issue_type="${{ steps.extract_issue_type.outputs.issue_type }}"
          title_without_type=$(echo "$title" | sed 's/^\[[^]]*\] //')
          converted_title="[BE/$issue_type] $title_without_type"
          echo "converted_title=$converted_title" >> $GITHUB_OUTPUT

      - name: Jira description JSONì„ ë¬¸ìì—´ë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
        id: escape_description
        run: |
          {
            echo "escaped_description<<EOF"
            echo '${{ steps.md2jira.outputs.output-text }}' | jq -R -s .
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # ref : https://developer.atlassian.com/cloud/jira/platform/rest/v2/api-group-issues/#api-rest-api-2-issue-post
      - name: Jira Task ìƒì„±
        id: create_jira_task
        uses: fjogeleit/http-request-action@v1
        with:
          url: '${{ secrets.JIRA_BASE_URL }}/rest/api/2/issue'
          method: 'POST'
          username: '${{ secrets.JIRA_USER_EMAIL }}'
          password: '${{ secrets.JIRA_API_TOKEN }}'
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "fields": {
                "project": {
                  "key": "${{ secrets.JIRA_PROJECT_KEY }}"
                },
                "issuetype": {
                  "name": "Task"
                },
                "summary": "${{ steps.convert_title.outputs.converted_title }}",
                "description": ${{ steps.escape_description.outputs.escaped_description }}
              }
            }

      - name: Jira task í‚¤ ì¶”ì¶œ
        id: extract_jira_task_key
        run: |
          task_key=$(echo '${{ steps.create_jira_task.outputs.response }}' | jq -r '.key')
          echo "task_key=$task_key" >> $GITHUB_OUTPUT
          echo "Created Jira issue: $task_key"

      - name: dev ë¸Œëœì¹˜ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          ref: dev

      - name: dev ë¸Œëœì¹˜ì— Jira í‹°ì¼“ ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•œ ë¸Œëœì¹˜ ìƒì„±
        run: |
          git checkout dev
          git pull
          git checkout -b ${{ steps.extract_issue_type.outputs.issue_type }}/${{ steps.extract_jira_task_key.outputs.task_key }}
          git push origin ${{ steps.extract_issue_type.outputs.issue_type }}/${{ steps.extract_jira_task_key.outputs.task_key }}

      # ref : https://github.com/actions-cool/issues-helper
      - name: ë‹´ë‹¹ì í• ë‹¹
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'add-assignees'
          token: ${{ secrets.GIT_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          assignees: ${{ github.event.issue.user.login }}

      - name: ë¸Œëœì¹˜ ìƒì„± ë° Jira ë§í¬ ëŒ“ê¸€ ì¶”ê°€
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GIT_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸª¾ **ìƒì„±ëœ ë¸Œëœì¹˜**: `${{ steps.extract_issue_type.outputs.issue_type }}/${{ steps.extract_jira_task_key.outputs.task_key }}`
            ğŸ”— **ì—°ê²°ëœ Jira Task**: <a href="${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract_jira_task_key.outputs.task_key }}" target="_blank">${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.extract_jira_task_key.outputs.task_key }}</a>
            âŒ¨ï¸ **ì´ìŠˆ ì‘ì—… ê°„ë‹¨ ëª…ë ¹ì–´**:
            ```
            git checkout dev && git pull && git checkout -b ${{ steps.extract_issue_type.outputs.issue_type }}/${{ steps.extract_jira_task_key.outputs.task_key }} origin/${{ steps.extract_issue_type.outputs.issue_type }}/${{ steps.extract_jira_task_key.outputs.task_key }}
            ```